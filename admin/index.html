<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>KYNDO Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0f14;
            --surface: #161b27;
            --surface2: #1e2535;
            --border: #2a3148;
            --accent: #6c63ff;
            --accent2: #4ade80;
            --danger: #f87171;
            --warn: #fbbf24;
            --text: #e2e8f0;
            --muted: #64748b;
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
        }

        /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        aside {
            width: 240px;
            min-height: 100vh;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            flex-shrink: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 8px 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand h1 {
            font-size: 18px;
            font-weight: 700;
        }

        .brand span {
            font-size: 11px;
            color: var(--muted);
        }

        nav a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 4px;
            cursor: pointer;
        }

        nav a:hover,
        nav a.active {
            background: var(--surface2);
            color: var(--text);
        }

        nav a.active {
            color: var(--accent);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--muted);
            margin-left: auto;
        }

        .status-dot.online {
            background: var(--accent2);
            box-shadow: 0 0 6px var(--accent2);
        }

        /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .page-header p {
            color: var(--muted);
            font-size: 14px;
            margin-top: 2px;
        }

        /* â”€â”€ Stats Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 8px;
        }

        .stat-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.15);
        }

        .btn-danger {
            background: rgba(248, 113, 113, 0.15);
            color: var(--danger);
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .btn-danger:hover {
            background: rgba(248, 113, 113, 0.25);
        }

        .btn-ghost {
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            border-color: var(--accent);
        }

        /* â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--surface2);
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-excepcional {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
        }

        .badge-rara {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .badge-frecuente {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }

        .badge-abundante {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .badge-default {
            background: var(--surface2);
            color: var(--muted);
        }

        /* â”€â”€ Card Thumbnail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card-thumb {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: var(--surface2);
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            overflow: hidden;
        }

        .card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop.open {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            width: 520px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* â”€â”€ Loading / Empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty {
            text-align: center;
            padding: 60px;
            color: var(--muted);
        }

        .empty .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 20px;
            font-size: 14px;
            color: var(--text);
            transform: translateY(80px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
            max-width: 320px;
        }

        #toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        #toast.success {
            border-left: 3px solid var(--accent2);
        }

        #toast.error {
            border-left: 3px solid var(--danger);
        }

        /* â”€â”€ Server status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .server-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .server-row:last-child {
            border-bottom: none;
        }

        .server-label {
            font-size: 14px;
            color: var(--muted);
        }

        .server-value {
            font-size: 14px;
            font-weight: 600;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .pill.online {
            background: rgba(74, 222, 128, 0.15);
            color: var(--accent2);
        }

        .pill.offline {
            background: rgba(248, 113, 113, 0.15);
            color: var(--danger);
        }
    </style>
</head>

<body>

    <!-- â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <aside>
        <div class="brand">
            <div class="brand-icon">ğŸƒ</div>
            <div>
                <h1>KYNDO</h1>
                <span>Admin Panel</span>
            </div>
        </div>

        <nav>
            <a class="active" onclick="navigate('dashboard')">ğŸ“Š <span>Dashboard</span></a>
            <a onclick="navigate('cards')">ğŸƒ <span>Cartas</span>
                <div class="status-dot" id="dot-cards"></div>
            </a>
            <a onclick="navigate('search')">ğŸ” <span>BÃºsqueda</span></a>
            <a onclick="navigate('server')">âš™ï¸ <span>Servidor</span>
                <div class="status-dot online" id="dot-server"></div>
            </a>
        </nav>
    </aside>

    <!-- â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main>

        <!-- â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page active" id="page-dashboard">
            <div class="page-header">
                <div>
                    <h2>Dashboard</h2>
                    <p>Vista general del sistema KYNDO</p>
                </div>
                <button class="btn btn-ghost" onclick="refreshDashboard()">â†» Actualizar</button>
            </div>

            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total de Cartas</div>
                    <div class="stat-value" id="stat-total">â€”</div>
                    <div class="stat-sub">en la base de datos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Estado del Servidor</div>
                    <div class="stat-value" id="stat-status">â€”</div>
                    <div class="stat-sub" id="stat-uptime">comprobando...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Cola de Tareas</div>
                    <div class="stat-value" id="stat-queue">â€”</div>
                    <div class="stat-sub">trabajos pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Timestamp</div>
                    <div class="stat-value" style="font-size:18px" id="stat-time">â€”</div>
                    <div class="stat-sub">Ãºltima actualizaciÃ³n</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ• Actividad Reciente</div>
                <div id="recent-cards">
                    <div class="empty">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page" id="page-cards">
            <div class="page-header">
                <div>
                    <h2>ğŸƒ Cartas</h2>
                    <p>Gestiona el catÃ¡logo completo de cartas</p>
                </div>
                <button class="btn btn-primary" onclick="importBirdsPack()" id="btn-import">&#128025; Importar Pack de Aves</button>
            </div>

            <div class="card">
                <div class="search-bar">
                    <input type="text" id="cards-search" placeholder="Buscar cartas por nombre o descripciÃ³n..." />
                    <button class="btn btn-primary" onclick="searchCards()">Buscar</button>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>Nombre</th>
                                <th>Card ID</th>
                                <th>Rareza</th>
                                <th>Pack</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cards-tbody">
                            <tr>
                                <td colspan="6">
                                    <div class="empty">
                                        <div class="spinner"></div>
                                        <p style="margin-top:12px">Cargando cartas...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="cards-pagination"
                    style="margin-top:16px; text-align:right; font-size:13px; color:var(--muted)"></div>
            </div>
        </div>

        <!-- â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page" id="page-search">
            <div class="page-header">
                <div>
                    <h2>ğŸ” BÃºsqueda Avanzada</h2>
                    <p>Prueba la API de bÃºsqueda de cartas</p>
                </div>
            </div>

            <div class="card">
                <div class="search-bar">
                    <input type="text" id="adv-search" placeholder="Ej: Guacamaya, TucÃ¡n, Ãguila..." />
                    <button class="btn btn-primary" onclick="advSearch()">Buscar</button>
                </div>
                <div id="adv-results">
                    <div class="empty">
                        <div class="icon">ğŸ”</div>
                        <p>Escribe algo para buscar cartas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- â”€â”€ SERVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page" id="page-server">
            <div class="page-header">
                <div>
                    <h2>âš™ï¸ Estado del Servidor</h2>
                    <p>Monitoreo en tiempo real del backend</p>
                </div>
                <button class="btn btn-ghost" onclick="checkServer()">â†» Revisar</button>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                <div class="card">
                    <div class="card-title">ğŸŸ¢ Salud del API</div>
                    <div id="server-health">
                        <div class="empty">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">ğŸ“‹ Cola de Tareas</div>
                    <div id="server-queue">
                        <div class="empty">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ”Œ Endpoints Disponibles</div>
                <table>
                    <thead>
                        <tr>
                            <th>MÃ©todo</th>
                            <th>Ruta</th>
                            <th>DescripciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-frecuente">GET</span></td>
                            <td>/health</td>
                            <td>Estado del servidor</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-frecuente">GET</span></td>
                            <td>/api/search?q=â€¦</td>
                            <td>Buscar cartas</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-frecuente">GET</span></td>
                            <td>/api/cards/:id/presentation</td>
                            <td>Datos de presentaciÃ³n de carta</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-excepcional">PATCH</span></td>
                            <td>/api/admin/cards/:id</td>
                            <td>Editar carta (requiere admin key)</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-frecuente">GET</span></td>
                            <td>/api/admin/queue/stats</td>
                            <td>EstadÃ­sticas de la cola</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- â•â• EDIT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="modal-backdrop" id="edit-modal">
        <div class="modal">
            <h3>âœï¸ Editar Carta</h3>
            <input type="hidden" id="edit-id" />
            <div class="form-group">
                <label>TÃ­tulo</label>
                <input type="text" id="edit-title" placeholder="Nombre de la carta" />
            </div>
            <div class="form-group">
                <label>DescripciÃ³n</label>
                <textarea id="edit-desc" placeholder="DescripciÃ³n de la carta..."></textarea>
            </div>
            <div class="form-group">
                <label>Rareza</label>
                <select id="edit-rarity">
                    <option value="abundante">Abundante</option>
                    <option value="frecuente">Frecuente</option>
                    <option value="rara">Rara</option>
                    <option value="excepcional">Excepcional</option>
                </select>
            </div>
            <div class="form-group">
                <label>Admin Key</label>
                <input type="password" id="edit-adminkey" placeholder="Clave de administrador" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveCard()">ğŸ’¾ Guardar</button>
            </div>
        </div>
    </div>

    <!-- â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="toast"></div>

    <script>
        const API = 'http://localhost:4001';

        // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function navigate(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            event.currentTarget.classList.add('active');

            if (page === 'dashboard') refreshDashboard();
            if (page === 'cards') loadCards('');
            if (page === 'server') checkServer();
        }

        // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toast(msg, type = 'success') {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.className = `show ${type}`;
            setTimeout(() => el.className = '', 3000);
        }

        // â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function refreshDashboard() {
            try {
                const [health, search, queue] = await Promise.allSettled([
                    fetch(`${API}/health`).then(r => r.json()),
                    fetch(`${API}/api/search?q=a&limit=100`).then(r => r.json()),
                    fetch(`${API}/api/admin/queue/stats`).then(r => r.json()),
                ]);

                if (health.status === 'fulfilled') {
                    const h = health.value;
                    document.getElementById('stat-status').textContent = h.status === 'ok' ? 'âœ… Online' : 'âŒ Error';
                    document.getElementById('stat-status').style.color = h.status === 'ok' ? 'var(--accent2)' : 'var(--danger)';
                    const mins = Math.floor(h.uptime / 60);
                    document.getElementById('stat-uptime').textContent = `corriendo por ${mins} min`;
                    document.getElementById('stat-time').textContent = new Date().toLocaleTimeString('es-ES');
                }

                if (search.status === 'fulfilled') {
                    document.getElementById('stat-total').textContent = search.value.count ?? 'â€”';

                    const cards = (search.value.results || []).slice(0, 5);
                    document.getElementById('recent-cards').innerHTML = cards.length === 0
                        ? '<div class="empty"><div class="icon">ğŸƒ</div><p>No hay cartas en la base de datos</p></div>'
                        : `<table><thead><tr><th></th><th>Nombre</th><th>Rareza</th><th>Card ID</th></tr></thead><tbody>
              ${cards.map(c => `
                <tr>
                  <td><div class="card-thumb">${c.thumbnailPath ? `<img src="${API}/${c.thumbnailPath}" onerror="this.parentNode.textContent='ğŸƒ'">` : 'ğŸƒ'}</div></td>
                  <td>${c.title}</td>
                  <td>${rarityBadge(c.rarity)}</td>
                  <td><code style="font-size:12px;color:var(--muted)">${c.cardId || 'â€”'}</code></td>
                </tr>`).join('')}
            </tbody></table>`;
                }

                if (queue.status === 'fulfilled') {
                    const q = queue.value;
                    document.getElementById('stat-queue').textContent = q.waiting ?? q.pending ?? '0';
                } else {
                    document.getElementById('stat-queue').textContent = 'â€”';
                }
            } catch (e) {
                toast('Error conectando al backend', 'error');
            }
        }

        // â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadCards(query) {
            const tbody = document.getElementById('cards-tbody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="empty"><div class="spinner"></div><p style="margin-top:12px">Cargando...</p></div></td></tr>';

            try {
                const q = query || 'a';
                const r = await fetch(`${API}/api/search?q=${encodeURIComponent(q)}&limit=100`);
                const data = await r.json();
                const cards = data.results || [];

                if (cards.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6"><div class="empty"><div class="icon">ğŸƒ</div><p>No se encontraron cartas</p></div></td></tr>';
                    return;
                }

                tbody.innerHTML = cards.map(c => `
        <tr>
          <td><div class="card-thumb">${c.thumbnailPath ? `<img src="${API}/${c.thumbnailPath}" onerror="this.parentNode.textContent='ğŸƒ'">` : 'ğŸƒ'}</div></td>
          <td><strong>${c.title}</strong></td>
          <td><code style="font-size:12px;color:var(--muted)">${c.cardId || 'â€”'}</code></td>
          <td>${rarityBadge(c.rarity)}</td>
          <td><span style="color:var(--muted);font-size:13px">${c.packId || 'â€”'}</span></td>
          <td>
            <button class="btn btn-ghost" style="padding:6px 10px;font-size:12px" onclick='openEdit(${JSON.stringify(c)})'>âœï¸ Editar</button>
          </td>
        </tr>`).join('');

                document.getElementById('cards-pagination').textContent = `${cards.length} cartas encontradas`;
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty"><div class="icon">âŒ</div><p>Error al cargar cartas. Â¿EstÃ¡ el backend corriendo?</p></div></td></tr>';
            }
        }

        function searchCards() {
            const q = document.getElementById('cards-search').value.trim() || 'a';
            loadCards(q);
        }

        // â”€â”€ Import Birds Pack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function importBirdsPack() {
            const btn = document.getElementById('btn-import');
            btn.disabled = true;
            btn.textContent = 'â³ Importando...';
            try {
                // Load pack from local file (relative to admin/)
                const packRes = await fetch('../birds/pack-1.json');
                if (!packRes.ok) throw new Error('No se pudo cargar birds/pack-1.json');
                const pack = await packRes.json();
                const assets = pack.assets || [];

                let created = 0, updated = 0, errors = 0;

                for (const asset of assets) {
                    try {
                        const tags = asset.tags || ['pares', 'kombat'];
                        const res = await fetch(`${API}/api/admin/cards`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                cardId: asset.id,
                                title: asset.title,
                                imageUrl: asset.image_url,
                                packId: 'birds',
                                tags
                            })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            if (data.created) created++; else updated++;
                        } else {
                            errors++;
                        }
                    } catch { errors++; }
                }

                toast(`ImportaciÃ³n completa: ${created} creadas, ${updated} actualizadas, ${errors} errores`, errors > 0 ? 'error' : 'success');
                loadCards('');
            } catch (e) {
                toast(`Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¦ Importar Pack de Aves';
            }
        }

        document.getElementById('cards-search').addEventListener('keypress', e => {
            if (e.key === 'Enter') searchCards();
        });

        // â”€â”€ Advanced Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function advSearch() {
            const q = document.getElementById('adv-search').value.trim();
            if (!q) return;

            const container = document.getElementById('adv-results');
            container.innerHTML = '<div class="empty"><div class="spinner"></div></div>';

            try {
                const r = await fetch(`${API}/api/search?q=${encodeURIComponent(q)}&limit=50`);
                const data = await r.json();
                const cards = data.results || [];

                if (cards.length === 0) {
                    container.innerHTML = `<div class="empty"><div class="icon">ğŸ˜•</div><p>No se encontraron cartas para "<strong>${q}</strong>"</p></div>`;
                    return;
                }

                container.innerHTML = `
        <p style="color:var(--muted);font-size:13px;margin-bottom:16px">${cards.length} resultado(s) para "<strong style="color:var(--text)">${q}</strong>"</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px">
          ${cards.map(c => `
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'" onclick='openEdit(${JSON.stringify(c)})'>
              <div style="width:100%;height:100px;background:var(--bg);border-radius:6px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:36px;overflow:hidden">
                ${c.thumbnailPath ? `<img src="${API}/${c.thumbnailPath}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentNode.textContent='ğŸƒ'">` : 'ğŸƒ'}
              </div>
              <div style="font-size:13px;font-weight:600;margin-bottom:4px">${c.title}</div>
              ${rarityBadge(c.rarity)}
            </div>`).join('')}
        </div>`;
            } catch (e) {
                container.innerHTML = '<div class="empty"><div class="icon">âŒ</div><p>Error al buscar. Â¿EstÃ¡ el backend corriendo?</p></div>';
            }
        }

        document.getElementById('adv-search').addEventListener('keypress', e => {
            if (e.key === 'Enter') advSearch();
        });

        // â”€â”€ Server Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function checkServer() {
            document.getElementById('server-health').innerHTML = '<div class="empty"><div class="spinner"></div></div>';
            document.getElementById('server-queue').innerHTML = '<div class="empty"><div class="spinner"></div></div>';

            try {
                const r = await fetch(`${API}/health`);
                const h = await r.json();
                const mins = Math.floor(h.uptime / 60);
                const secs = Math.floor(h.uptime % 60);

                document.getElementById('dot-server').className = 'status-dot online';
                document.getElementById('server-health').innerHTML = `
        <div class="server-row"><span class="server-label">Estado</span><span class="pill online">â— Online</span></div>
        <div class="server-row"><span class="server-label">Uptime</span><span class="server-value">${mins}m ${secs}s</span></div>
        <div class="server-row"><span class="server-label">Timestamp</span><span class="server-value" style="font-size:12px">${new Date(h.timestamp).toLocaleString('es-ES')}</span></div>
        <div class="server-row"><span class="server-label">Puerto</span><span class="server-value">4001</span></div>
      `;
            } catch (e) {
                document.getElementById('dot-server').className = 'status-dot';
                document.getElementById('server-health').innerHTML = `
        <div class="server-row"><span class="server-label">Estado</span><span class="pill offline">â— Offline</span></div>
        <div style="color:var(--muted);font-size:13px;padding-top:12px">No se puede conectar al backend en puerto 4001.</div>
      `;
            }

            try {
                const r = await fetch(`${API}/api/admin/queue/stats`);
                const q = await r.json();
                const entries = Object.entries(q);

                document.getElementById('server-queue').innerHTML = entries.length === 0
                    ? '<div style="color:var(--muted);font-size:14px;padding:12px 0">Cola vacÃ­a</div>'
                    : entries.map(([k, v]) => `<div class="server-row"><span class="server-label">${k}</span><span class="server-value">${v}</span></div>`).join('');
            } catch (e) {
                document.getElementById('server-queue').innerHTML = '<div style="color:var(--muted);font-size:13px;padding:12px 0">No disponible</div>';
            }
        }

        // â”€â”€ Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openEdit(card) {
            document.getElementById('edit-id').value = card.cardId || card.id;
            document.getElementById('edit-title').value = card.title || '';
            document.getElementById('edit-desc').value = card.description || '';
            document.getElementById('edit-rarity').value = card.rarity || 'abundante';
            document.getElementById('edit-modal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('open');
        }

        async function saveCard() {
            const id = document.getElementById('edit-id').value;
            const adminKey = document.getElementById('edit-adminkey').value;
            const body = {
                title: document.getElementById('edit-title').value,
                description: document.getElementById('edit-desc').value,
                rarity: document.getElementById('edit-rarity').value,
            };

            try {
                const r = await fetch(`${API}/api/admin/cards/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey,
                    },
                    body: JSON.stringify(body),
                });

                if (!r.ok) {
                    const err = await r.json();
                    throw new Error(err.error || 'Error al guardar');
                }

                toast('âœ… Carta actualizada con Ã©xito!');
                closeModal();
                if (document.getElementById('page-cards').classList.contains('active')) {
                    loadCards(document.getElementById('cards-search').value || 'a');
                }
            } catch (e) {
                toast(`âŒ ${e.message}`, 'error');
            }
        }

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function rarityBadge(rarity) {
            const map = {
                excepcional: 'badge-excepcional',
                rara: 'badge-rara',
                frecuente: 'badge-frecuente',
                abundante: 'badge-abundante',
            };
            const cls = map[rarity?.toLowerCase()] || 'badge-default';
            return `<span class="badge ${cls}">${rarity || 'â€”'}</span>`;
        }

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        refreshDashboard();
    </script>
</body>

</html>
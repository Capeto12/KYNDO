// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Card {
  id            String   @id @default(cuid())
  cardId        String   @unique // e.g., "guacamaya-roja"
  title         String
  description   String?  // For search support
  imageUrl      String?
  thumbnailPath String?
  rarity        String   @default("common") // common, rare, epic, legendary
  rarityV2      String?  @map("rarity_v2") // New rarity field for migrations
  packId        String   @default("birds")
  metadata      Json?    // Additional metadata as JSON
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  auditLogs AuditLog[]
  userCards  UserCard[]

  @@index([packId])
  @@index([rarity])
  @@index([title]) // Index for search performance
  @@map("cards")
}

model PresentationRule {
  id          String   @id @default(cuid())
  rarity      String   @unique // Rarity level this rule applies to
  frameColor  String   // Hex color for card frame
  glowEffect  Boolean  @default(false)
  badgeIcon   String?  // Icon name or URL
  sortOrder   Int      @default(0)
  metadata    Json?    // Additional presentation settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("presentation_rules")
}

model Asset {
  id           String   @id @default(cuid())
  assetKey     String   @unique // e.g., "thumbnails/guacamaya-roja-thumb.webp"
  assetType    String   // "thumbnail", "image", "icon", etc.
  filePath     String
  fileSize     Int?
  mimeType     String?
  metadata     Json?
  generatedBy  String?  // "sharp", "manual", etc.
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([assetType])
  @@map("assets")
}

model AuditLog {
  id          String   @id @default(cuid())
  cardId      String?
  action      String   // "update_rarity", "regenerate_thumbnail", etc.
  performedBy String   // Admin user identifier or "system"
  changes     Json?    // Details of what changed
  metadata    Json?    // Additional context
  createdAt   DateTime @default(now())

  card Card? @relation(fields: [cardId], references: [id])

  @@index([cardId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum CatalogCardType {
  A
  B
  C
}

enum CatalogRarity {
  common
  rare
  epic
  legendary
}

model Domain {
  id        String   @id @default(uuid()) @db.Uuid @map("domain_id")
  name      String   @unique @db.VarChar(100)
  status    String   @default("active") @db.VarChar(20)
  metadata  Json?    @default("{}")
  createdAt DateTime @default(now()) @map("created_at")

  objects Object[]

  @@index([status])
  @@map("domains")
}

model Object {
  id             String        @id @default(uuid()) @db.Uuid @map("object_id")
  domainId       String        @db.Uuid @map("domain_id")
  scientificName String?       @db.VarChar(255) @map("scientific_name")
  commonName     String?       @db.VarChar(255) @map("common_name")
  metadata       Json?         @default("{}")
  createdAt      DateTime      @default(now()) @map("created_at")

  domain        Domain         @relation(fields: [domainId], references: [id])
  images        ObjectImage[]
  catalogCards  CatalogCard[]
  attackFactors AttackFactor?
  defenseFactors DefenseFactor?

  @@index([domainId])
  @@index([scientificName])
  @@index([commonName])
  @@map("objects")
}

model ObjectImage {
  id           String   @id @default(uuid()) @db.Uuid @map("image_id")
  objectId     String   @db.Uuid @map("object_id")
  variantIndex Int      @map("variant_index")
  imagePath    String   @db.VarChar(500) @map("image_path")
  format       String   @default("webp") @db.VarChar(10)
  source       String?  @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at")

  object Object @relation(fields: [objectId], references: [id], onDelete: Cascade)

  @@unique([objectId, variantIndex])
  @@index([objectId])
  @@map("object_images")
}

model CatalogCard {
  id        String          @id @default(uuid()) @db.Uuid @map("card_id")
  objectId  String          @db.Uuid @map("object_id")
  type      CatalogCardType @map("type")
  rarity    CatalogRarity   @default(common)
  metadata  Json?           @default("{}")
  createdAt DateTime        @default(now()) @map("created_at")

  object Object @relation(fields: [objectId], references: [id], onDelete: Restrict)

  @@unique([objectId, type], map: "uq_object_type")
  @@index([objectId])
  @@index([type])
  @@index([rarity])
  @@map("catalog_cards")
}

model AttackFactor {
  objectId  String   @id @db.Uuid @map("object_id")
  p         Decimal  @db.Decimal(3, 1)
  s         Decimal  @db.Decimal(3, 1)
  w         Decimal  @db.Decimal(3, 1)
  h         Decimal  @db.Decimal(3, 1)
  a         Decimal  @db.Decimal(3, 1)
  createdAt DateTime @default(now()) @map("created_at")

  object Object @relation(fields: [objectId], references: [id], onDelete: Cascade)

  @@map("attack_factors")
}

model DefenseFactor {
  objectId  String   @id @db.Uuid @map("object_id")
  ad        Decimal  @db.Decimal(3, 1)
  c         Decimal  @db.Decimal(3, 1)
  e         Decimal  @db.Decimal(3, 1)
  sd        Decimal  @db.Decimal(3, 1)
  r         Decimal  @db.Decimal(3, 1)
  createdAt DateTime @default(now()) @map("created_at")

  object Object @relation(fields: [objectId], references: [id], onDelete: Cascade)

  @@map("defense_factors")
}

// ───────────────────────────────────────────────
// AUTH & USER SYSTEM
// ───────────────────────────────────────────────

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  username     String?
  role         String   @default("player") // "player" | "admin"
  isActive     Boolean  @default(true) @map("is_active")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  cards     UserCard[]
  purchases PackPurchase[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model UserCard {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  cardId    String   @map("card_id")
  quantity  Int      @default(1)
  source    String   @default("earned") // "earned" | "purchased" | "granted"
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([userId, cardId])
  @@index([userId])
  @@index([cardId])
  @@map("user_cards")
}

// ───────────────────────────────────────────────
// PACK STORE
// ───────────────────────────────────────────────

model Pack {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal  @default(0) @db.Decimal(10, 2)
  cardCount   Int      @default(5) @map("card_count")
  rarityPool  Json?    @map("rarity_pool") // weights per rarity
  isActive    Boolean  @default(true) @map("is_active")
  imageUrl    String?  @map("image_url")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  purchases PackPurchase[]

  @@index([isActive])
  @@map("packs")
}

model PackPurchase {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  packId    String   @map("pack_id")
  status    String   @default("completed") // "pending" | "completed" | "failed"
  cardsWon  Json?    @map("cards_won") // array of cardIds received
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack Pack @relation(fields: [packId], references: [id])

  @@index([userId])
  @@index([packId])
  @@map("pack_purchases")
}
